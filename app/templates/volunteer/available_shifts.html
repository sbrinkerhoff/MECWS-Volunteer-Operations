{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2 class="fw-bold">Available Shifts</h2>
        <p class="text-muted">Browse upcoming events and volunteer for shifts.</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card card-glass border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Date</th>
                                <th>Time</th>
                                <th class="text-center">Availability</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                            {% for shift in event.shifts %}
                            {% set signup_count = shift.signups.count() %}
                            {% set is_full = signup_count >= shift.capacity %}
                            {% set user_signed_up = shift.signups.filter_by(user_id=current_user.id).first() %}
                            <tr>
                                <td class="ps-4 fw-medium text-nowrap">
                                    {{ event.date.strftime('%a, %b %d, %Y') }}
                                    {% if event.description %}
                                    <div class="small text-muted">{{ event.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">
                                    {{ shift.start_time.strftime('%I:%M %p') }} - {{ shift.end_time.strftime('%I:%M %p')
                                    }}
                                </td>
                                <td class="text-center">
                                    {% if is_full %}
                                    <span class="badge bg-secondary">Full</span>
                                    {% elif user_signed_up %}
                                    <span class="badge bg-success">Signed Up</span>
                                    {% else %}
                                    <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle">{{
                                        shift.capacity - signup_count }} Spots Left</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    {% if not is_full and not user_signed_up %}
                                    <form action="{{ url_for('volunteer.signup', shift_id=shift.id) }}" method="POST">
                                        {# CSRF token handled globally if enabled #}
                                        <button type="submit" class="btn btn-sm btn-primary">Sign Up</button>
                                    </form>
                                    {% elif user_signed_up %}
                                    <a href="{{ url_for('volunteer.my_schedule') }}"
                                        class="btn btn-sm btn-outline-secondary">View My Schedule</a>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled>Full</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">
                                    No upcoming shifts available at the moment. Please check back later.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}